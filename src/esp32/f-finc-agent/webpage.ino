const char index_html[] PROGMEM = R"rawliteral(<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>F-FINC Agent Configuration</title><style>body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;background-color:#f4f7f6;color:#333}h1{color:#007bff;padding:20px 30px;margin:0;background-color:#fff;border-bottom:1px solid #ddd;display:flex;align-items:center}h2{color:#007bff;border-bottom:2px solid #e0e0e0;padding-bottom:10px;margin-bottom:20px}h1 svg{width:30px;height:30px;margin-right:15px;fill:#007bff}.container{display:flex;min-height:100vh}.content{flex-grow:1;padding:30px}.section{margin-bottom:30px;padding:20px;background-color:#fff;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.05)}.hidden{display:none!important}input[type=text],input[type=password],input[type=number]{padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:4px;width:calc(100% - 24px);box-sizing:border-box;display:inline-block}button{background-color:#007bff;color:#fff;padding:10px 15px;margin:10px 0;border:none;border-radius:4px;cursor:pointer;transition:background-color .3s ease}button:hover{background-color:#0056b3}.navbar{width:250px;background-color:#343a40;padding-top:20px;box-shadow:2px 0 5px rgba(0,0,0,.1);display:none}.navbar a{display:flex;align-items:center;color:#f8f9fa;padding:15px 20px;text-decoration:none;border-left:5px solid transparent;transition:background-color .3s,border-left-color .3s}.navbar a:hover{background-color:#495057}.navbar a.active{background-color:#007bff;border-left-color:#fff}.navbar a svg{width:18px;height:18px;margin-right:10px;fill:#f8f9fa}.navbar a.active svg{fill:#fff}table{border-collapse:collapse;width:100%;margin-top:15px}th,td{border:1px solid #ddd;padding:12px;text-align:left}th{background-color:#e9ecef;color:#495057}.led{height:15px;width:15px;border-radius:50%;display:inline-block;margin-right:10px;vertical-align:middle}.led-off{background-color:#ff4136;box-shadow:0 0 5px #ff4136}.led-on{background-color:#2ecc40;box-shadow:0 0 5px #2ecc40}.switch{position:relative;display:inline-block;width:60px;height:34px;vertical-align:middle}.switch input{opacity:0;width:0;height:0}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}.slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}input:checked+.slider{background-color:#2196F3}input:focus+.slider{box-shadow:0 0 1px #2196F3}input:checked+.slider:before{-webkit-transform:translateX(26px);-ms-transform:translateX(26px);transform:translateX(26px)}.progress-bar{background-color:#e9ecef;border-radius:5px;overflow:hidden;height:25px;margin:10px 0}.progress-fill{height:100%;background-color:#007bff;text-align:center;color:#fff;line-height:25px;font-size:14px;transition:width .5s}</style></head><body onload="fetchIOStatus(),fetchSystemInfo()"><div class="container"><div class="navbar" id="mainNavbar"><a href="#" class="nav-item active" onclick="showSection('ioStatusSection', this)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15H9v-2h2v2zm0-4H9v-2h2v2zm0-4H9V7h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/></svg> Trạng thái IO</a><a href="#" class="nav-item" onclick="showSection('systemInfoSection', this)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm0-4h-2V7h2v8z"/></svg> Thông tin Hệ thống</a><a href="#" class="nav-item" onclick="showSection('networkConfigSection', this)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 17c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7zm-1-8V7h2v4h-2zm-1 4h2v2h-2v-2z"/></svg> Cấu hình Mạng</a><a href="#" class="nav-item" onclick="showSection('alarmConfigSection', this)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12s4.48 10 10 10 10-4.48 10-10zm-10 8c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-12h2v6h-2z"/></svg> Cấu hình Cảnh báo</a><a href="#" class="nav-item" onclick="showSection('mqttConfigSection', this)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 3L2 12h3v8h14v-8h3L12 3zM7 18v-7.81l5-4.5 5 4.5V18H7z"/></svg> Cấu hình MQTT</a><a href="#" class="nav-item" onclick="showSection('apiConfigSection', this)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM8 7h8v2H8zm0 4h8v2H8zm0 4h5v2H8z"/></svg> Cấu hình REST API</a><a href="#" class="nav-item" onclick="showSection('firmwareUpdateSection', this)"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zm-4 7c0 .55-.45 1-1 1h-4c-.55 0-1-.45-1-1v-4H9v4c0 1.1.9 2 2 2h2c1.1 0 2-.9 2-2v-4h-1v4z"/></svg> Cập nhật Firmware</a></div><div class="content"><h1 id="pageTitle"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15H9v-2h2v2zm0-4H9v-2h2v2zm0-4H9V7h2v2zm4 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/></svg>F-FINC Agent Configuration</h1><div class="section" id="loginSection"><h2>Đăng nhập Hệ thống</h2><p>Vui lòng đăng nhập để truy cập các mục cấu hình.</p><input type="text" id="username" placeholder="Username (admin)"><input type="password" id="password" placeholder="Password (admin)"><button onclick="login()">Đăng nhập</button></div><div class="section hidden" id="ioStatusSection"><h2>Trạng thái IO (8 Inputs / 8 Outputs)</h2><div style="display:flex;justify-content:space-between;margin-bottom:20px"><input type="number" id="diInterval" placeholder="Interval cập nhật (s)" style="width:48%"><button onclick="saveDiInterval()" style="width:48%">Lưu Interval</button></div><h3>Inputs</h3><table><thead><tr><th>Input</th><th>GPIO</th><th>Trạng thái (ON = Xanh, OFF = Đỏ)</th></tr></thead><tbody id="inputTable"></tbody></table><h3>Outputs</h3><table><thead><tr><th>Output</th><th>GPIO</th><th>Trạng thái</th><th>Điều khiển</th></tr></thead><tbody id="outputTable"></tbody></table></div><div class="section hidden" id="systemInfoSection"><h2>Thông tin Hệ thống</h2><p>Phiên bản Firmware: <strong id="currentVersion">Đang tải...</strong></p><h3>Bộ xử lý (CPU)</h3><p>Tần số: <strong id="cpuFreq">N/A</strong> MHz, Số Core: <strong id="cpuCores">N/A</strong></p><h3>Bộ nhớ (RAM/Heap)</h3><p>Tổng RAM khả dụng: <strong id="ramTotal">N/A</strong> bytes</p><div class="progress-bar"><div id="ramUsageBar" class="progress-fill" style="width:0%"></div></div><p>Đã sử dụng: <span id="ramUsed">N/A</span> bytes | Còn trống: <span id="ramFree">N/A</span> bytes</p><h3>Bộ nhớ Flash (OTA/Sketch)</h3><p>Tổng Flash Chip: <strong id="flashTotal">N/A</strong> bytes</p><div class="progress-bar"><div id="flashUsageBar" class="progress-fill" style="width:0%; background-color: #ffc107"></div></div><p>Sketch đã sử dụng: <span id="flashUsed">N/A</span> bytes | Trống cho OTA: <span id="flashFree">N/A</span> bytes</p></div><div class="section hidden" id="networkConfigSection"><h2>Cấu hình Mạng</h2><p>Thiết bị sẽ tự tạo AP nếu không kết nối được WiFi. Dùng <strong>FINC_ESP32_SETUP</strong> / <strong>12345678</strong> để cấu hình lại.</p><input type="checkbox" id="useStaticIP"> Sử dụng IP tĩnh<br><input type="text" id="ipAddress" placeholder="IP Address (e.g., 192.168.1.10)"><input type="text" id="subnetMask" placeholder="Subnet Mask (e.g., 255.255.255.0)"><input type="text" id="gateway" placeholder="Gateway (e.g., 192.168.1.1)"><button onclick="saveNetworkConfig()">Lưu cấu hình Mạng</button></div><div class="section hidden" id="alarmConfigSection"><h2>Cấu hình Cảnh báo</h2><input type="text" id="alarmCondition" placeholder="Condition (e.g., input1 > 1)"> <input type="number" id="defaultInterval" placeholder="Default Interval (s)"> <input type="number" id="alarmInterval" placeholder="Alarm Interval (s)"> <button onclick="saveAlarmConfig()">Lưu cấu hình Cảnh báo</button></div><div class="section hidden" id="mqttConfigSection"><h2>Cấu hình MQTT</h2><div class="input-group"><label for="mqttEnabled"><input type="checkbox" id="mqttEnabled"> Bật/Tắt Gửi MQTT</label></div><input type="text" id="mqttUrl" placeholder="MQTT Broker URL"><input type="number" id="mqttPort" placeholder="Port"><input type="text" id="mqttTopic" placeholder="MQTT Topic (e.g., f-finc/data/01)"><input type="text" id="mqttUsername" placeholder="Username"><input type="password" id="mqttPassword" placeholder="Password"><button onclick="saveMqttConfig()">Lưu cấu hình MQTT</button></div><div class="section hidden" id="apiConfigSection"><h2>Cấu hình REST API</h2><div class="input-group"><label for="apiEnabled"><input type="checkbox" id="apiEnabled"> Bật/Tắt Gửi API POST</label></div><input type="text" id="apiUrl" placeholder="API Endpoint URL"><input type="text" id="apiUsername" placeholder="Username"><input type="password" id="apiPassword" placeholder="Password"><button onclick="saveApiConfig()">Lưu cấu hình REST API</button><hr><h3>Test Post API Data</h3><input type="text" id="apiData" placeholder="Data to post (JSON)" style="width:calc(100% - 24px)"><button onclick="postApiData()">Post Data</button></div><div class="section hidden" id="firmwareUpdateSection"><h2>Cập nhật Firmware (OTA)</h2><p>Phiên bản Hiện tại: <strong id="currentVersionOta">Đang tải...</strong></p><h3>Cấu hình Tự động Cập nhật</h3><input type="number" id="firmwareInterval" placeholder="Thời gian kiểm tra (giờ). Nhập 0 để tắt."><button onclick="saveFirmwareInterval()">Lưu Interval</button><hr style="margin: 20px 0;"><h3>Cập nhật Thủ công</h3><p>Nhấn nút dưới đây để yêu cầu thiết bị kiểm tra phiên bản mới ngay lập tức.</p><button onclick="checkFirmwareNow()">Kiểm tra Cập nhật Ngay</button></div></div></div><script>const configSections=['ioStatusSection','systemInfoSection','networkConfigSection','alarmConfigSection','mqttConfigSection','apiConfigSection','firmwareUpdateSection'];const inputGpios=[32,33,34,35,36,39,14,13];const outputGpios=[26,25,27,18,19,23,4,2];const numInputs=8;const numOutputs=8;function showSection(sectionId,navItem){configSections.forEach(id=>{document.getElementById(id).classList.add('hidden')});document.getElementById(sectionId).classList.remove('hidden');document.querySelectorAll('.nav-item').forEach(item=>{item.classList.remove('active')});navItem.classList.add('active')}function showConfigSections(){document.getElementById('loginSection').classList.add('hidden');document.getElementById('mainNavbar').style.display='block';document.querySelector('.container').style.display='flex';showSection('ioStatusSection',document.querySelector('#mainNavbar .nav-item:first-child'));buildIOTables()}async function login(){const username=document.getElementById('username').value;const password=document.getElementById('password').value;const response=await fetch('/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username,password})});if(response.ok){const result=await response.json();if(result.success){showConfigSections()}else{alert('Đăng nhập thất bại. Kiểm tra lại tên người dùng và mật khẩu.')}}else{alert('Lỗi: Không thể kết nối hoặc Server phản hồi lỗi.')}}function buildIOTables(){const inputTable=document.getElementById('inputTable');const outputTable=document.getElementById('outputTable');let inputHtml='';let outputHtml='';for(let i=0;i<numInputs;i++){inputHtml+=`<tr><td>Input ${i+1}</td><td>GPIO ${inputGpios[i]}</td><td><span id="input${i+1}Led" class="led led-off"></span> <span id="input${i+1}State">OFF</span></td></tr>`}for(let i=0;i<numOutputs;i++){outputHtml+=`<tr><td>Output ${i+1}</td><td>GPIO ${outputGpios[i]}</td><td><span id="output${i+1}Led" class="led led-off"></span> <span id="output${i+1}State">OFF</span></td><td><label class="switch"><input type="checkbox" id="output${i+1}Switch" onchange="toggleOutput(${i+1}, this.checked)"><span class="slider"></span></label></td></tr>`}inputTable.innerHTML=inputHtml;outputTable.innerHTML=outputHtml}async function toggleOutput(id,state){const ledElement=document.getElementById(`output${id}Led`);const stateElement=document.getElementById(`output${id}State`);try{ledElement.classList.remove('led-off','led-on');ledElement.classList.add('led-off');stateElement.innerText='Đang gửi lệnh...';const response=await fetch('/control/output',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id,state})});if(response.ok){const result=await response.json();if(result.success){updateOutputDisplay(id,result.state)}else{alert('Lỗi điều khiển Output: Server báo lỗi');document.getElementById(`output${id}Switch`).checked=!state}}else{throw new Error('Server error')}}catch(error){alert(`Lỗi: Không thể gửi lệnh điều khiển Output ${id}`);document.getElementById(`output${id}Switch`).checked=!state}}function updateOutputDisplay(id,state){const led=document.getElementById(`output${id}Led`);const stateText=document.getElementById(`output${id}State`);led.classList.remove('led-off','led-on');led.classList.add(state?'led-on':'led-off');stateText.innerText=state?'ON':'OFF';document.getElementById(`output${id}Switch`).checked=state}async function fetchIOStatus(){const response=await fetch('/io-status');if(response.ok){const data=await response.json();data.inputs.forEach(input=>{const led=document.getElementById(`input${input.id}Led`);const stateText=document.getElementById(`input${input.id}State`);if(led&&stateText){led.classList.remove('led-off','led-on');led.classList.add(input.state?'led-on':'led-off');stateText.innerText=input.state?'ON':'OFF'}});data.outputs.forEach(output=>{updateOutputDisplay(output.id,output.state)})}setTimeout(fetchIOStatus,3000)}function formatBytes(bytes,decimals=2){if(bytes===0)return'0 Bytes';const k=1024;const dm=decimals<0?0:decimals;const sizes=['Bytes','KB','MB','GB','TB'];const i=Math.floor(Math.log(bytes)/Math.log(k));return parseFloat((bytes/Math.pow(k,i)).toFixed(dm))+' '+sizes[i]}function updateProgressBar(elementId,value,total,color='#007bff'){const bar=document.getElementById(elementId);const percent=Math.round((value/total)*100);bar.style.width=`${percent}%`;bar.innerText=`${percent}%`;bar.style.backgroundColor=color}async function fetchSystemInfo(){const response=await fetch('/system-info');if(response.ok){const data=await response.json();document.getElementById('currentVersion').innerText=data.firmware_version.toFixed(2);document.getElementById('currentVersionOta').innerText=data.firmware_version.toFixed(2);const ramUsed=data.ram_total-data.ram_free;document.getElementById('cpuFreq').innerText=data.cpu_freq;document.getElementById('cpuCores').innerText=data.cpu_cores;document.getElementById('ramTotal').innerText=formatBytes(data.ram_total);document.getElementById('ramUsed').innerText=formatBytes(ramUsed);document.getElementById('ramFree').innerText=formatBytes(data.ram_free);updateProgressBar('ramUsageBar',ramUsed,data.ram_total,'#2ecc40');document.getElementById('flashTotal').innerText=formatBytes(data.flash_total);document.getElementById('flashUsed').innerText=formatBytes(data.flash_used);document.getElementById('flashFree').innerText=formatBytes(data.flash_free_update);updateProgressBar('flashUsageBar',data.flash_used,data.flash_total,'#ffc107')}setTimeout(fetchSystemInfo,10000)}async function saveNetworkConfig(){const staticIp=document.getElementById('useStaticIP').checked;const ipAddress=document.getElementById('ipAddress').value;const subnetMask=document.getElementById('subnetMask').value;const gateway=document.getElementById('gateway').value;const response=await fetch('/config/network',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({staticIp,ipAddress,subnetMask,gateway})});const result=await response.json();alert('Cấu hình mạng '+(result.success?'đã lưu. Thiết bị sẽ khởi động lại.':'thất bại'))}async function saveAlarmConfig(){const condition=document.getElementById('alarmCondition').value;const defaultInterval=document.getElementById('defaultInterval').value;const alarmInterval=document.getElementById('alarmInterval').value;const response=await fetch('/config/alarm',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({condition,defaultInterval:parseInt(defaultInterval),alarmInterval:parseInt(alarmInterval)})});const result=await response.json();alert('Cấu hình cảnh báo '+(result.success?'đã lưu':'thất bại'))}async function saveDiInterval(){alert('Interval cho Digital Inputs đã lưu.')}async function saveMqttConfig(){const enabled=document.getElementById('mqttEnabled').checked;const url=document.getElementById('mqttUrl').value;const port=document.getElementById('mqttPort').value;const topic=document.getElementById('mqttTopic').value;const username=document.getElementById('mqttUsername').value;const password=document.getElementById('mqttPassword').value;const response=await fetch('/config/mqtt',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled,url,port:parseInt(port),topic,username,password})});const result=await response.json();alert('Cấu hình MQTT '+(result.success?'đã lưu':'thất bại'))}async function saveApiConfig(){const enabled=document.getElementById('apiEnabled').checked;const url=document.getElementById('apiUrl').value;const username=document.getElementById('apiUsername').value;const password=document.getElementById('apiPassword').value;const response=await fetch('/config/api',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled,url,username,password})});const result=await response.json();alert('Cấu hình API '+(result.success?'đã lưu':'thất bại'))}async function postApiData(){const data=document.getElementById('apiData').value;const response=await fetch('/api/post',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:data})});const result=await response.json();alert('Post API '+(result.success?'thành công':'thất bại'))}async function saveFirmwareInterval(){const interval=document.getElementById('firmwareInterval').value;const response=await fetch('/firmware/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({interval:parseInt(interval)})});const result=await response.json();alert('Cấu hình Firmware: '+(result.success?'Đã lưu interval':'Thất bại'))}async function checkFirmwareNow(){if(confirm('Bạn có chắc muốn kiểm tra và cập nhật firmware ngay bây giờ không? Thiết bị có thể sẽ khởi động lại nếu có phiên bản mới.')){alert('Đã gửi yêu cầu kiểm tra. Vui lòng theo dõi console (Serial) của thiết bị để xem tiến trình.');const response=await fetch('/firmware/check-now');const result=await response.json();if(!result.success){alert('Gửi yêu cầu thất bại.')}}}</script></body></html>)rawliteral";